<html>
    <head>
        <title>render page</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    </head>
    <body>
        <h1>Welcome <%=user.name%></h1>
        <p id="email"><%=user.email%></p>
        <button type="button" class="btn btn-primary" onClick="addItem()">Add item</button>
        <h3>Your trancation history:</h3>
        <table class="table">
            <thead>
                <th>Product Name</th>
                <th>quantity</th>
                <th>total price</th>
            </thead>
            <% for(let i=0; i < transcation.length ; i++){%>
                <tr>
                    <td><%= transcation[i].productName %></td>
                    <td><%= transcation[i].quantity %></td>
                    <td><%= transcation[i].totalAmount %></td>
                </tr>
                <%}%>
            <tbody>

            </tbody>
        </table>
        <h3>Product list:</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>product id</th>
                    <th>product name</th>
                    <th>price</th>
                    <th>quantity</th>
                </tr>
            </thead>
            <tbody>
                <% for (var i = 0; i < quotation.length; i++) { %>
                    <% if(quotation[i].IsDelete) {%>
                        <% continue %>
                    <%} else {%>
                    <tr>
                      <td><%= quotation[i]._id %></td>
                      <td><%= quotation[i].productName %></td>
                      <td><%= quotation[i].price %></td>
                      <td><%= quotation[i].quantity %></td>
                      <td><button type="button" class="btn btn-primary">update</button></td>
                      <td><button type="button" class="btn btn-primary" onclick="itemDelete(this)">delete</button></td>
                      <td><button type="button" class="btn btn-primary" onclick="buy(this)">buy</button></td>
                    </tr> 
                    <%}%>   
                <% } %>
            </tbody>
        </table>
    </body>
    <script>
        function addItem()
        {
            console.log("working");
            let myHeaders = new Headers();
            let useremail=document.getElementById('email').innerHTML;
            myHeaders.append("Content-Type", "application/json");
            let raw = JSON.stringify({
            email: useremail,
            productName: prompt("name of the product"),
            price:prompt("price of the product"),
            quantity:prompt("quantity of the product")
            });


            let requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow",
            mode: 'cors',
            cache: 'default',
            };

            fetch("/api/v1/add-item", requestOptions)
            .then((response) =>{
                return response.text()})
            .then((result) => {
                console.log(result);
            })
            .catch((error) => console.log("cannot add item", error));
    }
    function buy(event){
        console.log("working");
        var myHeaders = new Headers();
        var useremail=document.getElementById('email').innerHTML;
        myHeaders.append("Content-Type", "application/json");
        quantity=+prompt("how many item do you want",1);
        let childs= event.parentNode.parentNode.childNodes;
        let productId=childs[1].innerHTML;
        let price=childs[5].innerHTML;
        console.log(quantity*+price)
        var raw = JSON.stringify({
        email: useremail,
        productId: productId,
        totalAmount:+quantity*+price,
        quantity:quantity
        });

        let requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow",
            mode: 'cors',
            cache: 'default',
            };

            fetch("/api/v1/purchase-item", requestOptions)
            .then((response) =>{
                return response.text()})
            .then((result) => {
                console.log(result);
            })
            .catch((error) => console.log("cannot add item", error));

    }
    function itemDelete(event)
    {
        var myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");
        let childs= event.parentNode.parentNode.childNodes;
        let productId=childs[1].innerHTML;

        var raw = JSON.stringify({
        productId: productId
        });

        let requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow",
            mode: 'cors',
            cache: 'default',
            };

            fetch("/api/v1/delete-item", requestOptions)
            .then((response) =>{
                return response.text()})
            .then((result) => {
                console.log(result);
            })
            .catch((error) => console.log("cannot add item", error));
    }
    </script>
</html>